<component name="ca.firstvoices.usermapper.contrib">

  	<require>org.nuxeo.ecm.directory.sql.SQLDirectoryFactory</require>

  	<implementation class="org.nuxeo.ecm.directory.sql.SQLDirectoryDescriptor" />
  
  <extension target="org.nuxeo.ecm.directory.sql.SQLDirectoryFactory"
    point="directories">
    <directory name="sqlUserDirectory">
      <schema>user</schema>
      <dataSource>jdbc/nxsqldirectory</dataSource>
	
	<table>users</table>
	      <idField>username</idField>
	      <passwordField>password</passwordField>
	      <passwordHashAlgorithm>SSHA</passwordHashAlgorithm>
	      
	      <fieldMapping name="contributors">contributors</fieldMapping>
	      <fieldMapping name="comments">comments</fieldMapping>
	      
	      <autoincrementIdField>false</autoincrementIdField>
	      <computeMultiTenantId>false</computeMultiTenantId>
	      <dataFile>users.csv</dataFile>
	      <createTablePolicy>on_missing_columns</createTablePolicy>
	      <querySizeLimit>50</querySizeLimit>
	      <references>
	        <inverseReference field="groups" directory="sqlGroupDirectory"
	          dualReferenceField="members" />
	      </references>
	    </directory>
	    <directory name="sqlGroupDirectory">
	      <schema>group</schema>
	      <dataSource>jdbc/nxsqldirectory</dataSource>
	
	<table>groups</table>
	      <idField>groupname</idField>
	      <dataFile>groups.csv</dataFile>
	      <createTablePolicy>on_missing_columns</createTablePolicy>
	      <autoincrementIdField>false</autoincrementIdField>
	      <!-- Add 10 min cache to avoid refetching the groups during login -->
	      <cacheTimeout>360</cacheTimeout>
	      <cacheMaxSize>1000</cacheMaxSize>
	      <references>
	        <tableReference field="members" directory="multiUserDirectory"
	          table="user2group" sourceColumn="groupId" targetColumn="userId" schema="user2group"
	          dataFile="user2group.csv" />
	        <tableReference field="subGroups" directory="sqlGroupDirectory"
	          table="group2group" sourceColumn="parentGroupId"
	          targetColumn="childGroupId" schema="group2group" />
	        <inverseReference field="parentGroups" directory="sqlGroupDirectory"
	          dualReferenceField="subGroups" />
	      </references>
	    </directory>
	  </extension>

	<extension target="org.nuxeo.usermapper.service.UserMapperComponent" point="mapper">
	
	  <mapper name="fv" type="js">
	    <mapperScript>
            searchAttributes.put("username", userObject.username);
	        userAttributes.put("username", userObject.username);
	        userAttributes.put("email", userObject.email);
	        userAttributes.put("firstName", userObject.firstName);
	        userAttributes.put("lastName", userObject.lastName);
	        userAttributes.put("comments", userObject.comments);
	        userAttributes.put("contributors", userObject.contributors);
	    </mapperScript>
	  </mapper>
	
	</extension>
	
</component>
